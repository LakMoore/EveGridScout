<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GridScout Local Reports Dashboard</title>
    <script src="https://unpkg.com/htmx.org@1.9.5"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css">
    <style>
        :root {
            color-scheme: dark;
        }

        body {
            margin: 0;
            min-height: 100vh;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            background: radial-gradient(circle at top, #1f2937 0%, #111827 50%, #0b1020 100%);
            color: #e5e7eb;
            padding: 24px;
        }

        h1 {
            color: #f9fafb;
            margin: 0 0 14px;
            font-size: 1.6rem;
        }

        .page-card {
            background: rgba(17, 24, 39, 0.93);
            border: 1px solid #374151;
            border-radius: 14px;
            box-shadow: 0 12px 36px rgba(0, 0, 0, 0.45);
            padding: 20px;
            margin-top: 48px;
            margin-bottom: 18px;
        }

        .wrap-cell {
            min-width: 200px;
            white-space: normal !important;
            word-break: break-word;
        }

        .header-actions {
            position: absolute;
            top: 20px;
            right: 30px;
            z-index: 1000;
            display: flex;
            gap: 12px;
        }

        .mdc-button {
            background: rgba(55, 65, 81, 0.9) !important;
            border-color: #4b5563 !important;
            color: #e5e7eb !important;
        }

        .mdc-button--raised {
            box-shadow: none !important;
        }

        .mdc-data-table {
            background: transparent !important;
            border-color: #374151 !important;
            width: 100%;
        }

        .mdc-data-table__table {
            border-collapse: collapse;
            width: 100%;
        }

        .mdc-data-table__header-cell {
            color: #9ca3af !important;
            border-bottom-color: #374151 !important;
            background: rgba(31, 41, 55, 0.85);
            font-weight: 600;
        }

        .mdc-data-table__cell {
            color: #e5e7eb !important;
            border-bottom-color: #374151 !important;
            background: transparent;
        }

        .mdc-data-table__row:hover .mdc-data-table__cell {
            background: rgba(55, 65, 81, 0.3) !important;
        }
    </style>
</head>

<body>
    <div class="header-actions">
        <a href="<%= fix_path('/') %>" class="mdc-button mdc-button--raised">
            <i class="material-icons mdc-button__icon" aria-hidden="true">dashboard</i>
            <span class="mdc-button__label">Dashboards</span>
        </a>
        <a href="<%= fix_path('/errors') %>" class="mdc-button mdc-button--raised">
            <i class="material-icons mdc-button__icon" aria-hidden="true">error</i>
            <span class="mdc-button__label">Error Logs</span>
        </a>
        <a href="<%= fix_path('/install') %>" class="mdc-button mdc-button--raised">
            <i class="material-icons mdc-button__icon" aria-hidden="true">install_mobile</i>
            <span class="mdc-button__label">Install Client</span>
        </a>
    </div>

    <%- include("partials/local-reports-card", { localReports, nullSecPocketName, timeAgo }) %>

    <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
    <script>
        mdc.autoInit();

        (function setupRealtimeUpdates() {
            if (typeof EventSource === "undefined") {
                return;
            }

            const eventSource = new EventSource("<%= fix_path('/events/stream') %>");
            const refreshDebounceMs = 500;
            let debounceTimer = null;
            let refreshInFlight = false;
            let refreshQueued = false;
            let lastUpdateSignalAt = 0;
            let pendingFilteredUpdates = Number(window.gridScoutPendingFilteredUpdates ?? 0);

            const notifyPendingUpdatesChanged = () => {
                window.gridScoutPendingFilteredUpdates = pendingFilteredUpdates;
                if (typeof window.gridScoutOnPendingUpdatesChanged === "function") {
                    window.gridScoutOnPendingUpdatesChanged(pendingFilteredUpdates);
                }
            };

            const isPilotFilterActive = () => {
                return String(window.gridScoutSelectedPilot ?? "").trim().length > 0;
            };

            const incrementPendingFilteredUpdates = () => {
                pendingFilteredUpdates += 1;
                notifyPendingUpdatesChanged();
            };

            function runDashboardRefresh() {
                if (refreshInFlight) {
                    refreshQueued = true;
                    return;
                }

                refreshInFlight = true;
                htmx.ajax("GET", "<%= fix_path('/fragments/local/reports') %>", {
                    target: "#local-reports-card",
                    swap: "outerHTML"
                }).finally(function () {
                    refreshInFlight = false;
                    pendingFilteredUpdates = 0;
                    notifyPendingUpdatesChanged();
                    if (refreshQueued) {
                        refreshQueued = false;
                        scheduleDashboardRefresh();
                    }
                });
            }

            function scheduleDashboardRefresh() {
                if (isPilotFilterActive()) {
                    incrementPendingFilteredUpdates();
                    return;
                }

                if (debounceTimer !== null) {
                    window.clearTimeout(debounceTimer);
                }

                debounceTimer = window.setTimeout(function () {
                    debounceTimer = null;
                    runDashboardRefresh();
                }, refreshDebounceMs);
            }

            function handleIncomingUpdateSignal() {
                const now = Date.now();
                if (now - lastUpdateSignalAt < 150) {
                    return;
                }
                lastUpdateSignalAt = now;
                scheduleDashboardRefresh();
            }

            window.gridScoutRequestDashboardRefresh = function () {
                pendingFilteredUpdates = 0;
                notifyPendingUpdatesChanged();
                scheduleDashboardRefresh();
            };

            window.gridScoutAcknowledgePendingUpdates = function () {
                pendingFilteredUpdates = 0;
                notifyPendingUpdatesChanged();
            };

            notifyPendingUpdatesChanged();

            eventSource.addEventListener("report-ingested", function () {
                handleIncomingUpdateSignal();
            });

            eventSource.onmessage = function () {
                handleIncomingUpdateSignal();
            };

            eventSource.onerror = function () {
                // Allow the browser EventSource auto-reconnect behavior.
            };
        })();
    </script>
</body>

</html>
