<div class="page-card" id="local-reports-card">
    <h1>Local reports in <%= nullSecPocketName %>:</h1>
    <div id="pilot-filter-status" style="display: none; margin: 0 0 8px 0; align-items: center; gap: 8px; color: #d1d5db;">
        <span style="font-weight: 600;">Current filter:</span>
        <span id="pilot-filter-name" style="padding: 2px 8px; border: 1px solid #4b5563; border-radius: 9999px; background: rgba(34,197,94,0.15); color: #86efac;"></span>
        <button
            id="pilot-filter-clear"
            type="button"
            style="background: transparent; border: 1px solid #4b5563; color: #d1d5db; border-radius: 6px; padding: 2px 8px; cursor: pointer;"
            title="Clear pilot filter"
            aria-label="Clear pilot filter">Clear</button>
    </div>
    <div id="friendlies-toggle-row" style="display: flex; margin: 0 0 8px 0; align-items: center; gap: 8px; color: #d1d5db;">
        <button
            id="friendlies-toggle-button"
            type="button"
            style="background: transparent; border: 1px solid #4b5563; color: #d1d5db; border-radius: 6px; padding: 2px 8px; cursor: pointer;"
            title="Hide friendlies">Hide friendlies</button>
    </div>
    <div class="mdc-data-table" data-mdc-auto-init="MDCDataTable">
        <table class="mdc-data-table__table" aria-label="Local Reports Table">
            <thead>
                <tr class="mdc-data-table__header-row">
                    <th class="mdc-data-table__header-cell" role="columnheader" scope="col" style="width: 46px; text-align: center;">&nbsp;</th>
                    <th class="mdc-data-table__header-cell" role="columnheader" scope="col">System</th>
                    <th class="mdc-data-table__header-cell" role="columnheader" scope="col" style="width: 90px; text-align: center;">Delta</th>
                    <th class="mdc-data-table__header-cell" role="columnheader" scope="col" style="width: 320px;">Current Locals</th>
                    <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Latest Update</th>
                    <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Latest Reporter</th>
                </tr>
            </thead>
            <tbody class="mdc-data-table__content">
                <% localReports.forEach((report, reportIndex) => { %>
                    <%
                        const reportPilotNames = Array.from(new Set([
                            ...report.currentLocals.map((pilot) => String(pilot.name ?? "").trim().toLowerCase()),
                            ...report.history.flatMap((entry) => [
                                ...(entry.snapshotLocals ?? []).map((name) => String(name ?? "").trim().toLowerCase()),
                                ...entry.addedPilots.map((pilot) => String(pilot.name ?? "").trim().toLowerCase()),
                                ...entry.removedPilots.map((pilot) => String(pilot.name ?? "").trim().toLowerCase()),
                            ]),
                        ].filter((name) => !!name)));
                    %>
                    <tr class="mdc-data-table__row" data-report-row="true" data-report-index="<%= reportIndex %>" data-pilot-names="<%= reportPilotNames.join('|') %>">
                        <td class="mdc-data-table__cell" style="width: 46px; text-align: center;text-overflow: clip;">
                            <button
                                type="button"
                                aria-label="Toggle history for <%= report.system %>"
                                aria-expanded="false"
                                title="Show or hide history"
                                style="background: transparent; color: #d1d5db; border: none; cursor: pointer; font-size: 30px; line-height: 1; padding: 0 4px;"
                                onclick="(function(button,rowId){var row=document.getElementById(rowId);if(!row){return;}var isExpanded=row.style.display==='table-row';row.style.display=isExpanded?'none':'table-row';button.setAttribute('aria-expanded',isExpanded?'false':'true');button.textContent=isExpanded?'▸':'▾';if(window.gridScoutReapplyPilotFilter){window.gridScoutReapplyPilotFilter();}})(this,'local-history-<%= reportIndex %>');">▸</button>
                        </td>
                        <td class="mdc-data-table__cell wrap-cell"><%= report.system %></td>
                        <td class="mdc-data-table__cell" style="width: 90px; text-align: center; white-space: nowrap;">
                            <% if (report.delta.added === 0 && report.delta.removed === 0) { %>
                                0
                            <% } else { %>
                                <% if (report.delta.added > 0) { %>
                                    +<%= report.delta.added %>
                                <% } %>
                                <% if (report.delta.added > 0 && report.delta.removed > 0) { %>
                                    /
                                <% } %>
                                <% if (report.delta.removed > 0) { %>
                                    -<%= report.delta.removed %>
                                <% } %>
                            <% } %>
                        </td>
                        <td class="mdc-data-table__cell" style="width: 320px;">
                            <div style="display: flex; flex-direction: column; gap: 2px; padding: 6px 0;">
                                <% report.currentLocals.forEach((pilot) => { %>
                                    <%- include("pilot-item", { pilot, reporterName: report.latestReporter }) %>
                                <% }) %>
                            </div>
                        </td>
                        <td class="mdc-data-table__cell" title="<%= new Date(report.latestTime).toUTCString().replace('GMT', 'EVE') %>">
                            <div style="white-space:nowrap;"><%= timeAgo(new Date(report.latestTime)) %></div>
                        </td>
                        <td class="mdc-data-table__cell wrap-cell"><%= report.latestReporter %></td>
                    </tr>
                    <tr class="mdc-data-table__row" id="local-history-<%= reportIndex %>" data-history-row="true" data-report-index="<%= reportIndex %>" style="display: none;">
                        <td class="mdc-data-table__cell" colspan="6" style="padding-top: 0;">
                            <div style="margin: 8px 0 4px 0; display: grid; gap: 8px;">
                                <% report.history.forEach((entry) => { %>
                                    <%
                                        const historyEntryPilotNames = Array.from(new Set([
                                            ...(entry.snapshotLocals ?? []).map((name) => String(name ?? "").trim().toLowerCase()),
                                            ...entry.addedPilots.map((pilot) => String(pilot.name ?? "").trim().toLowerCase()),
                                            ...entry.removedPilots.map((pilot) => String(pilot.name ?? "").trim().toLowerCase()),
                                        ].filter((name) => !!name)));
                                    %>
                                    <div data-history-entry="true" data-pilot-names="<%= historyEntryPilotNames.join('|') %>" style="border: 1px solid #374151; border-radius: 8px; padding: 8px;">
                                        <div style="display: grid; grid-template-columns: minmax(260px, 1.2fr) minmax(220px, 1fr) minmax(220px, 1fr); gap: 12px; align-items: start;">
                                            <div>
                                                <div style="font-weight: 600; margin-bottom: 4px;">
                                                    <%= new Date(entry.minuteStart).toUTCString().replace('GMT', 'EVE') %>
                                                </div>
                                                <div style="color: #9ca3af; margin-bottom: 6px;">
                                                    <%= timeAgo(new Date(entry.latestTime)) %>
                                                </div>
                                                <div>
                                                    <%= entry.reportCount %> report<%= entry.reportCount === 1 ? '' : 's' %>
                                                </div>
                                                <div style="margin-top: 4px;">Reporters: <%= entry.reporters.join(', ') || 'Unknown' %></div>
                                            </div>

                                            <div>
                                                <div style="font-weight: 600; margin-bottom: 4px;">Added</div>
                                                <% if (entry.addedPilots.length === 0) { %>
                                                    <div>None</div>
                                                <% } else { %>
                                                    <div data-history-pilot-column="added" style="display: flex; flex-direction: column; gap: 2px; padding: 2px 0;">
                                                        <% entry.addedPilots.forEach((pilot) => { %>
                                                            <div data-history-pilot-chip="true" data-pilot-name="<%= String(pilot.name ?? '').trim().toLowerCase() %>">
                                                                <%- include("pilot-item", { pilot, reporterNames: entry.reporters }) %>
                                                            </div>
                                                        <% }) %>
                                                    </div>
                                                <% } %>
                                            </div>

                                            <div>
                                                <div style="font-weight: 600; margin-bottom: 4px;">Removed</div>
                                                <% if (entry.removedPilots.length === 0) { %>
                                                    <div>None</div>
                                                <% } else { %>
                                                    <div data-history-pilot-column="removed" style="display: flex; flex-direction: column; gap: 2px; padding: 2px 0;">
                                                        <% entry.removedPilots.forEach((pilot) => { %>
                                                            <div data-history-pilot-chip="true" data-pilot-name="<%= String(pilot.name ?? '').trim().toLowerCase() %>">
                                                                <%- include("pilot-item", { pilot, reporterNames: entry.reporters }) %>
                                                            </div>
                                                        <% }) %>
                                                    </div>
                                                <% } %>
                                            </div>
                                        </div>
                                    </div>
                                <% }); %>
                                <div data-history-empty="true" style="display: none; color: #9ca3af; font-style: italic;">No matching history events for selected pilot.</div>
                            </div>
                        </td>
                    </tr>
                <% }); %>
            </tbody>
        </table>
    </div>
</div>

<script>
    (function () {
        const container = document.getElementById("local-reports-card");
        if (!container) {
            return;
        }
        const filterStatus = document.getElementById("pilot-filter-status");
        const filterName = document.getElementById("pilot-filter-name");
        const clearFilterButton = document.getElementById("pilot-filter-clear");
        const friendliesToggleRow = document.getElementById("friendlies-toggle-row");
        const friendliesToggleButton = document.getElementById("friendlies-toggle-button");
        const filterStorageKey = "gridscout.local.pilotFilter";
        const friendliesStorageKey = "gridscout.local.hideFriendlies";

        const normalizePilotName = (name) => String(name ?? "").trim().toLowerCase();

        const parsePilotNames = (value) => {
            if (!value) {
                return [];
            }
            return String(value)
                .split("|")
                .map((name) => normalizePilotName(name))
                .filter((name) => !!name);
        };

        const applyPilotChipBackgrounds = () => {
            const chips = container.querySelectorAll(".pilot-chip");
            chips.forEach((chip) => {
                const background = chip.getAttribute("data-pilot-background");
                if (background) {
                    chip.style.background = background;
                }
            });
        };

        const getHideFriendliesState = () => {
            if (typeof window.gridScoutHideFriendlies === "boolean") {
                return window.gridScoutHideFriendlies;
            }

            try {
                const stored = window.sessionStorage.getItem(friendliesStorageKey);
                if (stored === "1") {
                    window.gridScoutHideFriendlies = true;
                    return true;
                }
            } catch (_error) {
                // ignore storage issues
            }

            window.gridScoutHideFriendlies = false;
            return false;
        };

        const setHideFriendliesState = (hideFriendlies) => {
            window.gridScoutHideFriendlies = !!hideFriendlies;
            try {
                if (window.gridScoutHideFriendlies) {
                    window.sessionStorage.setItem(friendliesStorageKey, "1");
                } else {
                    window.sessionStorage.removeItem(friendliesStorageKey);
                }
            } catch (_error) {
                // ignore storage issues
            }
        };

        const isFriendlyPilotChip = (chip) => {
            return String(chip?.getAttribute("data-is-friendly") ?? "").toLowerCase() === "true";
        };

        const isSelectedPilotFriendly = (selectedPilot) => {
            if (!selectedPilot) {
                return false;
            }

            const chips = container.querySelectorAll(".pilot-chip");
            return Array.from(chips).some((chip) => {
                const chipPilotName = normalizePilotName(chip.getAttribute("data-pilot-name"));
                return chipPilotName === selectedPilot && isFriendlyPilotChip(chip);
            });
        };

        const updateFriendliesToggleUi = (selectedPilot, selectedPilotIsFriendly) => {
            if (!friendliesToggleRow || !friendliesToggleButton) {
                return;
            }

            const canToggleFriendlies = !selectedPilot || !selectedPilotIsFriendly;
            if (!canToggleFriendlies) {
                friendliesToggleRow.style.display = "none";
                return;
            }

            friendliesToggleRow.style.display = "flex";
            const hideFriendlies = getHideFriendliesState();
            friendliesToggleButton.textContent = hideFriendlies ? "Show friendlies" : "Hide friendlies";
            friendliesToggleButton.title = hideFriendlies ? "Show friendly pilots" : "Hide friendly pilots";
        };

        const rowMatchesPilot = (row, selectedPilot) => {
            if (!selectedPilot) {
                return true;
            }
            const names = parsePilotNames(row.getAttribute("data-pilot-names"));
            return names.includes(selectedPilot);
        };

        const updateClearButtonState = () => {
            if (!clearFilterButton) {
                return;
            }

            const resetClearButtonStyle = () => {
                clearFilterButton.style.borderColor = "#4b5563";
                clearFilterButton.style.color = "#d1d5db";
                clearFilterButton.style.background = "transparent";
            };

            const selectedPilot = normalizePilotName(container.getAttribute("data-selected-pilot"));
            if (!selectedPilot) {
                clearFilterButton.textContent = "Clear";
                clearFilterButton.title = "Clear pilot filter";
                resetClearButtonStyle();
                return;
            }

            const pendingUpdates = Number(window.gridScoutPendingFilteredUpdates ?? 0);
            if (pendingUpdates > 0) {
                clearFilterButton.textContent = `Clear this filter to see ${pendingUpdates} update${pendingUpdates === 1 ? "" : "s"}`;
                clearFilterButton.title = "Clear this filter and refresh latest updates";
                clearFilterButton.style.borderColor = "#ef4444";
                clearFilterButton.style.color = "#ffffff";
                clearFilterButton.style.background = "rgba(239, 68, 68, 0.25)";
                return;
            }

            clearFilterButton.textContent = "Clear";
            clearFilterButton.title = "Clear pilot filter";
            resetClearButtonStyle();
        };

        const historyEntryMatchesPilot = (entry, selectedPilot) => {
            if (!selectedPilot) {
                return true;
            }

            const chips = entry.querySelectorAll("[data-history-pilot-chip='true']");
            if (chips.length > 0) {
                return Array.from(chips).some((chip) => {
                    const chipPilotName = normalizePilotName(chip.getAttribute("data-pilot-name"));
                    return chipPilotName === selectedPilot;
                });
            }

            return rowMatchesPilot(entry, selectedPilot);
        };

        const applyPilotFilter = (pilotName) => {
            const selectedPilot = normalizePilotName(pilotName || "");
            const selectedPilotDisplay = String(pilotName ?? "").trim();
            container.setAttribute("data-selected-pilot", selectedPilot);
            applyPilotChipBackgrounds();

            const selectedPilotIsFriendly = isSelectedPilotFriendly(selectedPilot);
            let hideFriendlies = getHideFriendliesState();
            if (selectedPilot && selectedPilotIsFriendly && hideFriendlies) {
                hideFriendlies = false;
                setHideFriendliesState(false);
            }

            updateFriendliesToggleUi(selectedPilot, selectedPilotIsFriendly);

            try {
                if (selectedPilot) {
                    window.gridScoutSelectedPilot = selectedPilot;
                    window.gridScoutSelectedPilotDisplay = selectedPilotDisplay || selectedPilot;
                    window.sessionStorage.setItem(
                        filterStorageKey,
                        JSON.stringify({
                            pilot: selectedPilot,
                            display: window.gridScoutSelectedPilotDisplay,
                        }),
                    );
                } else {
                    window.gridScoutSelectedPilot = "";
                    window.gridScoutSelectedPilotDisplay = "";
                    window.sessionStorage.removeItem(filterStorageKey);
                }
            } catch (_error) {
                // ignore storage errors (private mode / browser policy)
            }

            if (filterStatus && filterName) {
                if (selectedPilot) {
                    filterStatus.style.display = "flex";
                    filterName.textContent = selectedPilotDisplay || selectedPilot;
                } else {
                    filterStatus.style.display = "none";
                    filterName.textContent = "";
                }
            }

            updateClearButtonState();

            const reportRows = container.querySelectorAll("tr[data-report-row='true']");
            reportRows.forEach((row) => {
                const matchesPilotFilter = rowMatchesPilot(row, selectedPilot);

                const reportIndex = row.getAttribute("data-report-index");
                const historyRow = reportIndex
                    ? container.querySelector(`#local-history-${reportIndex}`)
                    : null;

                if (!historyRow) {
                    row.style.display = matchesPilotFilter ? "table-row" : "none";
                    return;
                }

                if (!matchesPilotFilter) {
                    row.style.display = "none";
                    historyRow.style.display = "none";
                    const toggleButton = row.querySelector("button[aria-label^='Toggle history']");
                    if (toggleButton) {
                        toggleButton.setAttribute("aria-expanded", "false");
                        toggleButton.textContent = "▸";
                    }
                    return;
                }

                const currentPilotChips = row.querySelectorAll(".pilot-chip");
                let visibleCurrentPilotCount = 0;
                currentPilotChips.forEach((chip) => {
                    const hideThisChip = hideFriendlies && isFriendlyPilotChip(chip);
                    chip.style.display = hideThisChip ? "none" : "flex";
                    if (!hideThisChip) {
                        visibleCurrentPilotCount += 1;
                    }
                });

                const historyEntries = historyRow.querySelectorAll("[data-history-entry='true']");
                let visibleHistoryCount = 0;
                historyEntries.forEach((entry) => {
                    const entryHasSelectedPilot = historyEntryMatchesPilot(entry, selectedPilot);
                    const entryPilotChips = entry.querySelectorAll("[data-history-pilot-chip='true']");
                    let visibleEntryPilotCount = 0;

                    entryPilotChips.forEach((chipWrapper) => {
                        const chip = chipWrapper.querySelector(".pilot-chip");
                        const hideThisChip = !!chip && hideFriendlies && isFriendlyPilotChip(chip);
                        chipWrapper.style.display = hideThisChip ? "none" : "block";
                        if (!hideThisChip) {
                            visibleEntryPilotCount += 1;
                        }
                    });

                    const entryVisible = entryHasSelectedPilot && visibleEntryPilotCount > 0;
                    entry.style.display = entryVisible ? "block" : "none";
                    if (entryVisible) {
                        visibleHistoryCount += 1;
                    }
                });

                const showRow = matchesPilotFilter;
                row.style.display = showRow ? "table-row" : "none";
                if (!showRow) {
                    historyRow.style.display = "none";
                    const toggleButton = row.querySelector("button[aria-label^='Toggle history']");
                    if (toggleButton) {
                        toggleButton.setAttribute("aria-expanded", "false");
                        toggleButton.textContent = "▸";
                    }
                }

                const emptyState = historyRow.querySelector("[data-history-empty='true']");
                if (emptyState) {
                    const anyFilterActive = !!selectedPilot || hideFriendlies;
                    emptyState.style.display = visibleHistoryCount === 0 && anyFilterActive ? "block" : "none";
                }
            });

            const filterButtons = container.querySelectorAll(".pilot-filter-toggle");
            filterButtons.forEach((button) => {
                const buttonPilot = normalizePilotName(button.getAttribute("data-pilot-name"));
                const isActive = !!selectedPilot && buttonPilot === selectedPilot;
                button.setAttribute("data-filter-active", isActive ? "true" : "false");
                button.setAttribute("aria-pressed", isActive ? "true" : "false");
                button.style.borderColor = isActive ? "#ffffff" : "#4b5563";
                button.style.color = isActive ? "#ffffff" : "#d1d5db";
                button.style.background = "transparent";
                button.title = isActive
                    ? "Filtering by this pilot (click to clear)"
                    : "Filter by this pilot";
            });
        };

        window.gridScoutTogglePilotFilter = function (pilotName) {
            const normalizedPilot = normalizePilotName(pilotName);
            const currentPilot = normalizePilotName(container.getAttribute("data-selected-pilot"));
            applyPilotFilter(currentPilot === normalizedPilot ? "" : String(pilotName ?? "").trim());
        };

        window.gridScoutReapplyPilotFilter = function () {
            const currentPilot = String(container.getAttribute("data-selected-pilot") ?? "");
            applyPilotFilter(currentPilot);
        };

        if (clearFilterButton) {
            clearFilterButton.addEventListener("click", () => {
                const hadFilter = normalizePilotName(container.getAttribute("data-selected-pilot")).length > 0;
                applyPilotFilter("");
                if (hadFilter && typeof window.gridScoutAcknowledgePendingUpdates === "function") {
                    window.gridScoutAcknowledgePendingUpdates();
                }
            });
        }

        if (friendliesToggleButton) {
            friendliesToggleButton.addEventListener("click", () => {
                setHideFriendliesState(!getHideFriendliesState());
                const selectedPilotDisplay = String(
                    window.gridScoutSelectedPilotDisplay ?? container.getAttribute("data-selected-pilot") ?? "",
                ).trim();
                applyPilotFilter(selectedPilotDisplay);
            });
        }

        window.gridScoutOnPendingUpdatesChanged = function () {
            updateClearButtonState();
        };

        const getInitialFilterValue = () => {
            if (window.gridScoutSelectedPilot) {
                return String(window.gridScoutSelectedPilotDisplay || window.gridScoutSelectedPilot);
            }

            try {
                const storedRaw = window.sessionStorage.getItem(filterStorageKey);
                if (!storedRaw) {
                    return container.getAttribute("data-selected-pilot") || "";
                }

                const parsed = JSON.parse(storedRaw);
                const storedPilot = normalizePilotName(parsed?.pilot);
                const storedDisplay = String(parsed?.display ?? "").trim();
                if (storedPilot) {
                    window.gridScoutSelectedPilot = storedPilot;
                    window.gridScoutSelectedPilotDisplay = storedDisplay || storedPilot;
                    return window.gridScoutSelectedPilotDisplay;
                }
            } catch (_error) {
                // ignore parse/storage issues and fall back to container state
            }

            return container.getAttribute("data-selected-pilot") || "";
        };

        applyPilotFilter(getInitialFilterValue());
    })();
</script>
